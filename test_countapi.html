<!doctype html>
<meta charset="utf-8">
<title>countapi.dev Test</title>
<style>body{font-family:system-ui;padding:24px} code{background:#f6f8fa;padding:2px 4px;border-radius:4px}</style>
<h1>countapi.dev 測試</h1>
<p>👀 瀏覽：<b id="views">—</b>　|　🧑‍🤝‍🧑 唯一：<b id="uniques">—</b></p>
<pre id="log" style="background:#f6f8fa;padding:12px;border-radius:8px;white-space:pre-wrap;"></pre>

<script>
(async function () {
  const log = (...a)=>{ document.getElementById('log').textContent += a.join(' ') + '\n'; };
  const set = (id,v)=>{ document.getElementById(id).textContent = (v||0).toLocaleString('zh-TW'); };

  const NS = 'investorfuji-btcplan-test';    // 測試專用命名空間
  const TOTAL = 'pageviews';
  const UNIQUE = 'uniques';
  const FLAG = 'fuji_calc_unique_flag_test';
  const BASE = 'https://api.countapi.dev';

  const hit = (k)=> fetch(`${BASE}/hit/${encodeURIComponent(NS)}/${encodeURIComponent(k)}`, {cache:'no-store'});
  const get = (k)=> fetch(`${BASE}/get/${encodeURIComponent(NS)}/${encodeURIComponent(k)}`, {cache:'no-store'});

  try {
    const r = await hit(TOTAL);
    const d = await r.json();
    set('views', d.value);
    log('views ok:', JSON.stringify(d));
  } catch (e) {
    log('views error:', e);
  }

  try {
    let seen = false;
    try { seen = !!localStorage.getItem(FLAG); } catch (e) {}
    const req = seen ? get(UNIQUE) : hit(UNIQUE);
    if (!seen) { try { localStorage.setItem(FLAG, '1'); } catch (e) {} }
    const r2 = await req;
    const d2 = await r2.json();
    set('uniques', d2.value);
    log('uniques ok:', JSON.stringify(d2), 'seen?', seen);
  } catch (e) {
    log('uniques error:', e);
  }
})();
</script>
